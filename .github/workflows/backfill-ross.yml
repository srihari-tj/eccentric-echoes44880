name: Backfill ROSS Quarter Rankings (manual)

on:
  workflow_dispatch:
    inputs:
      year:
        description: "Year (e.g., 2025)"
        required: true
        default: "2025"
      quarters:
        description: "Quarters to build (comma-separated from Q1,Q2,Q3,Q4)"
        required: true
        default: "Q1,Q2,Q3,Q4"

permissions:
  contents: write

jobs:
  ross:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install deps
        run: npm install node-fetch@2
      - name: Validate weekly presence
        run: |
          if [ ! -d "data/derived/weekly" ]; then
            echo "data/derived/weekly missing; run your normal pipeline first."
            exit 1
          fi
      - name: Build ROSS rankings
        run: |
          Y="${{ inputs.year }}"
          QS=$(echo "${{ inputs.quarters }}" | tr ' ' ',' | tr -s ',' | tr '[:lower:]' '[:upper:]')
          IFS=',' read -r -a ARR <<< "$QS"
          to_num(){ case "$1" in Q1)echo 1;;Q2)echo 2;;Q3)echo 3;;Q4)echo 4;;*)echo "";; esac; }
          for q in "${ARR[@]}"; do
            N=$(to_num "$q"); [ -z "$N" ] && { echo "skip $q"; continue; }
            echo "ROSS rank $Y $q"
            node scripts/rank_ross_quarter.js "$Y" "$N"
          done
      - name: Commit ROSS quarter files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/derived/quarter-ross
          git commit -m "ROSS backfill (${{ inputs.year }}: ${{ inputs.quarters }}) ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))" || echo "no changes"
          git push
