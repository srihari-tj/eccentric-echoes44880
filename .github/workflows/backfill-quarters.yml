name: Backfill Quarter Rankings (Q1–Q3, manual)

on:
  workflow_dispatch:
    inputs:
      year:
        description: "Year to backfill (e.g., 2025)"
        required: true
        default: "2025"
      quarters:
        description: "Quarters to build (comma-separated from Q1,Q2,Q3). Default: Q1,Q2,Q3"
        required: false
        default: "Q1,Q2,Q3"

permissions:
  contents: write

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install minimal deps
        run: npm install node-fetch@2

      - name: Echo inputs
        run: |
          echo "year=${{ inputs.year }}"
          echo "quarters=${{ inputs.quarters }}"

      - name: Validate weekly data presence
        run: |
          if [ ! -d "data/derived/weekly" ]; then
            echo "data/derived/weekly not found. This backfill requires existing weekly JSON files."
            exit 1
          fi
          # List a few files for debug
          ls -1 data/derived/weekly | head -n 5 || true

      - name: Build Q1–Q3 rankings (no new fetch)
        run: |
          Y="${{ inputs.year }}"
          QS="${{ inputs.quarters }}"
          # Normalize quarters list
          QS_CLEAN=$(echo "$QS" | tr ' ' ',' | tr -s ',' | tr '[:lower:]' '[:upper:]')
          IFS=',' read -r -a ARR <<< "$QS_CLEAN"
          # Map Qn -> number
          to_num() {
            case "$1" in
              Q1) echo 1 ;;
              Q2) echo 2 ;;
              Q3) echo 3 ;;
              Q4) echo 4 ;;
              *) echo "" ;;
            esac
          }
          for q in "${ARR[@]}"; do
            N=$(to_num "$q")
            if [ -z "$N" ]; then
              echo "Skipping invalid quarter token: $q"
              continue
            fi
            echo "Ranking $Y $q"
            node scripts/rank_quarter.js "$Y" "$N"
          done

      - name: Commit quarter files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/derived/quarter
          git commit -m "backfill quarters (${{ inputs.year }}: ${{ inputs.quarters }}) ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))" || echo "no changes"
          git push
